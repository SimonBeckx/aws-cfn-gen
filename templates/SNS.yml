---
### TODO: SNS Subscriptions and subscription filters

AWSTemplateFormatVersion: '2010-09-09'
Description: |
  Create one or more SNS Topics

Resources:
{% for topic in sns %}
{%   set sns_cfn_name = topic.display_name | replace('-', ' ') | replace('_', ' ') | replace('.', ' ') | title | replace(' ', '') %}
  SNS{{ sns_cfn_name }}:
    Type: AWS::SNS::Topic
    Properties:
      DisplayName: "{{ topic.display_name }}"
{%   if topic.topic_name is defined %}
      TopicName: "{{ topic.topic_name }}"
{%   endif %}

{%   for subscription in topic.subscriptions | default([]) %}
{%     set subscr_cfn_name = subscription.name | replace('-', ' ') | replace('_', ' ') | replace('.', ' ') | title | replace(' ', '') %}
{%     if subscription.endpoint_export is defined %}
{%       set subscr_endpoint = subscription.endpoint_export %}
{%     elif subscription.endpoint_arn is defined %}
{%       set subscr_endpoint = subscription.endpoint_arn %}
{%     endif %}

  SNSSubscr{{ subscr_cfn_name }}:
    DependsOn:
      - SNS{{ sns_cfn_name }}
    Type: AWS::SNS::Subscription
    Properties:
      Endpoint: "{{ subscr_endpoint }}"
      Protocol: {{ subscription.protocol | default('lambda') }}
      TopicArn: !Ref SNS{{ sns_cfn_name }}
{%     if subscription.filter_policy is defined %}
      FilterPolicy: '{{ subscription.filter_policy }}'
{%     endif %}

{%     if subscription.protocol == 'lambda' %}
  LambdaInvokePermission{{ subscr_cfn_name }}:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      Principal: sns.amazonaws.com
      SourceArn: !Ref SNS{{ sns_cfn_name }}
      FunctionName: "{{ subscr_endpoint }}"
{%     endif %}
{%   endfor %}

{% endfor %}

Outputs:
{% for topic in sns %}
{%   set sns_cfn_name = topic.display_name | replace('-', ' ') | replace('_', ' ') | replace('.', ' ') | title | replace(' ', '') %}
  SNS{{ sns_cfn_name }}Output:
    Value: !Ref SNS{{ sns_cfn_name }}
    Description: "SNS topic {{ sns_cfn_name }} resource logical name"
    Export:
      Name: !Sub "${AWS::StackName}-{{ sns_cfn_name }}"

{% endfor %}